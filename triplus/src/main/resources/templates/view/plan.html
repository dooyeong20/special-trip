<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="layout/common_layout">

<div layout:fragment="content">
    <section class="ftco-section bg-light">
        <div class="container">
            <div class="col-md-7 heading-section ftco-animate fadeInUp ftco-animated">
                <h2 class="mb-4"><strong>나의 일정</strong> 만들기 </h2>
            </div>

            <div class="form-group">
                <div class="row">
                    <input th:value="${plan} ? ${plan.name} : ''" type="text" class="form-control col-4 mb-2 mr-sm-2 " id="plan_title" placeholder="일정 이름">
                    <input th:value="${plan} ? ${plan.id} : 0" id="plan_id" type="hidden">
                    <button type="button" id="save-all-btn" class="btn btn-primary mb-2 mr-sm-2">
                        SAVE
                    </button>
                </div>
            </div>
            <th:block th:unless="${plan}">
                <div class="form-group">
                    <div class="row">
                        <div class="col-4 day" style="display: none !important">
                            <h2 class="text-center">Day</h2>
                            <div class="card" style="height: 500px">
                                <div style="height:450px; overflow-y: scroll;" class="mt-4">
                                    <div class="card-body">
                                        <div class="row mb-3">
                                            <button type="button" class="btn btn-default mb-2 mr-sm-2 delete_btn">
                                                DELETE
                                            </button>
                                        </div>

                                        <!-- 돌하르방 div-->
                                        <div class="block-21 mb-4 mt-4 d-flex place" style="display: none !important">
                                        </div>

                                        <div class="col text-center">
                                            <button type="button" class="btn btn-default mb-2 mr-sm-2 add_btn" data-toggle="modal" data-target="#myModal">
                                                +
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-4 day">
                            <h2 class="text-center">Day</h2>
                            <div class="card" style="height: 500px">
                                <div style="height:450px; overflow-y: scroll;" class="mt-4">
                                    <div class="card-body">
                                        <div class="row mb-3">
                                            <button type="button" class="btn btn-default mb-2 mr-sm-2 delete_btn day_del_btn">
                                                DELETE
                                            </button>
                                        </div>

                                        <!-- 돌하르방 div-->
                                        <div class="block-21 mb-4 mt-4 d-flex place" style="display: none !important">
                                        </div>

                                        <div class="col text-center">
                                            <button type="button" class="btn btn-default mb-2 mr-sm-2 add_btn" data-toggle="modal" data-target="#myModal">
                                                +
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </th:block>

            <th:block th:if="${plan}">
                <div class="form-group">
                    <div class="row">
                        <div class="col-4 day" style="display: none !important">
                        </div>

                        <th:block th:each="day : ${plan.days}">
                            <div class="col-4 day">
                                <h2 class="text-center">Day</h2>
                                <div class="card" style="height: 500px">
                                    <div style="height:450px; overflow-y: scroll;" class="mt-4">
                                        <div class="card-body">
                                            <div class="row mb-3">
                                                <button type="button" class="btn btn-default mb-2 mr-sm-2 delete_btn day_del_btn">
                                                    DELETE
                                                </button>
                                            </div>

                                            <!-- 기본 place div-->
                                            <div class="block-21 mb-4 mt-4 d-flex place" style="display: none !important">
                                            </div>

                                            <th:block th:each="place : ${day.places}">
                                                <div class="block-21 mb-4 mt-4 d-flex place">
                                                    <a class="blog-img mr-4" th:style="'background:url(' + ${place.thumbnailUrl} + '); background-size: cover; background-repeat: no-repeat;'"></a>
                                                    <div class="text">
                                                        <h3 class="heading"><a th:href="'/detail?content_id=' + ${place.contentId}" th:text="${place.name}"></a></h3>
                                                        <p th:text="${place.addr}"></p>
                                                    </div>
                                                </div>
                                            </th:block>

                                            <div class="col text-center">
                                                <button type="button" class="btn btn-default mb-2 mr-sm-2 add_btn" data-toggle="modal" data-target="#myModal">
                                                    +
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </th:block>

                    </div>
                </div>
            </th:block>


            <div class="col text-center">
                <button type="button" id="card_add" class="btn btn-primary card_add">
                    ADD
                </button>
            </div>
        </div>
    </section>

    <!- modal -->
    <div class="modal fade" id="myModal">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">

                <!-- Modal Header -->
                <div class="modal-header">
                    <h4 class="modal-title">Modal Heading</h4>
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                </div>

                <!-- Modal body -->
                <div class="modal-body">
                    <div class="ftco-animate fadeInUp ftco-animated">
                        <input class="typeahead" type="text" id="search" onkeyup="filter()" placeholder="명소를 검색하세요."/>
                        <div style="height:500px; overflow-y: scroll;">

                            <!-- 카드들 담기는 곳-->
                            <div class="placeList">
                                <th:block th:each="place : ${placeList}">
                                    <div class="col-12 ftco-animate fadeInUp ftco-animated">
                                        <div class="block-21 mb-4 d-flex placeBox">
                                            <input type="hidden" id="contentId" th:value="${place.contentId}">
                                            <a class="blog-img mr-4 placeImage" th:style="'background:url(' + ${place.thumbnailUrl} + ')'"></a>
                                            <div class="text">
                                                <h3 class="heading placeTitle" th:text="${place.name}"></h3>
                                                <p class="placeAddr" th:text="${place.addr1}"></p>
                                            </div>
                                        </div>
                                    </div>
                                </th:block>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Modal footer -->
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>

            </div>
        </div>
    </div>


    <script type="text/javascript">
        $(document).ready(function(){   // ready 시작
            make_place = function(url, title, addr, content_id){
                return '<div class="block-21 mb-4 mt-4 d-flex place">' +
                '    <a class="blog-img mr-4" style="background:url(' + url + '); background-size: cover; background-repeat: no-repeat;"></a>' +
                '    <div class="text">' +
                '    <h3 class="heading"><a href="/detail?content_id=' + content_id + '">' + title + '</a></h3>' +
                '        <p>' + addr + '</p>' +
                '    </div>' +
                '</div>';
            }

            var card = `<div class="col-4 day">
                    <h2 class="text-center">Day</h2>
                    <div class="card" style="height: 500px">
                        <div style="height:450px; overflow-y: scroll;" class="mt-4">
                            <div class="card-body mb-3">
                                <div class="row">
                                    <button type="button" class="btn btn-default mb-2 mr-sm-2 delete_btn day_del_btn">
                                            DELETE
                                    </button>
                                </div>

                                <div class="block-21 mb-4 mt-4 d-flex place" style="display:none !important">
                                </div>

                                <div class="col text-center">
                                    <button type="button" class="btn btn-default mb-2 mr-sm-2 add_btn" data-toggle="modal" data-target="#myModal">
                                        +
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                `

            add_btn_click = function(){
                var add_place_btn = $(this);
                var last_place = add_place_btn.parent().parent().find(".place:last");

                last_place.addClass('last-place');
            }


            $(".add_btn").unbind().click(add_btn_click);


            // 검색해서 클릭했을 때
            $(".placeBox").click(function(){
                var imgUrl = $(this).find("a").css('background');
                var title = $(this).find(".text").find("h3").text();
                var addr = $(this).find(".text").find("p").text();
                var content_id = $(this).find("#contentId").val();
                // -------------------------------
                console.log(content_id);
                // -------------------------------

                var last_place = $(".last-place");
                imgUrl = imgUrl.replace(/.*\s?url\([\'\"]?/, '').replace(/[\'\"]?\).*/, '');

                // console.log(imgUrl);
                // console.log(title);
                // console.log(addr);

                $('#myModal').modal('hide');

                // TODO content_id 작업 해줘야함
                last_place.after(make_place(imgUrl, title, addr, content_id));
                last_place.removeClass('last-place');
            });

            // 새로울 Day를 만들 때
            $(".card_add").click(function(){
                $(".last-place").removeClass('last-place');

                $(".day:last").after(card);

                $(".add_btn").unbind().click(add_btn_click);

                $('.day_del_btn').click(function(){
                    console.log('1234');
                    $(this).parent().parent().parent().parent().parent().remove();
                });



            }); // card_add btn click 끝


            // 저장할 때
            $('#save-all-btn').click(function(){
                day = [];

                dayList = $('.day').toArray().map(function(day){
                    var tmp = [];

                    $(day).find('.place').toArray().forEach(d => {
                        if(!$(d).find('a').css('background')) return;

                        var title = $(d).find('.text').find('.heading').text();
                        var addr = $(d).find('.text').find('p').text();
                        var imgUrl = $(d).find('a').css('background').replace(/.*\s?url\([\'\"]?/, '').replace(/[\'\"]?\).*/, '');
                        var contentId = 3223;
                        var jsonObj = JSON.parse('{ "title": "' + title + '", "imgUrl": "' + imgUrl +'", "addr":"' + addr + '", "content_id":"' + contentId + '"}');

                        tmp.push(jsonObj);
                    });

                    return tmp;
                });


                jsonObj = {
                    "plan" : $('#plan_title').val(),
                    "planId" : $('#plan_id').val(),
                    "dayList": dayList.slice(1)
                };

                $.ajax({
                    url: '/plan/save',
                    type: 'post',
                    dataType: 'json',
                    data: JSON.stringify({plan:$('#plan_title').val(), planId:$('#plan_id').val(), dayList:dayList.slice(1)}),
                    contentType: 'application/json; charset=UTF-8',
                    success: function(response) {
                        console.log(response + '로 설정 완료!');
                        $('#plan_id').val(response);
                    }
                }).done(function(response) {
                    console.log('done!');
                });

            });

            // delete 할 때
            $('.day_del_btn').click(function(){
                console.log('1234');
                $(this).parent().parent().parent().parent().parent().remove();
            });


        }); // ready 끝

    </script>

    <script>
        function filter() {
            let search = document.getElementById("search").value.toLowerCase();
            let placeList = document.getElementsByClassName("placeList")[0];
            console.log(placeList.children);

            let placeTitle = placeList.getElementsByClassName("placeTitle");

            for (let i = 0; i < placeList.children.length; i++) {
                if (placeTitle[i].innerHTML.toLowerCase().indexOf(search) != -1) {
                    placeTitle[i].parentNode.parentNode.parentNode.style.display = "flex" // placeBox
                } else {
                    placeTitle[i].parentNode.parentNode.parentNode.style.display = "none"
                }
            }
        }
    </script>

</div>
</html>